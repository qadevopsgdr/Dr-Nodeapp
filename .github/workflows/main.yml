name: Deploy Node App to EC2 - cicd.yaml..17th nov

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout Repository
      - name: Checkout Code
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Load EC2 SSH Key
      - name: Load SSH Key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > ec2key.pem
          chmod 400 ec2key.pem

      # 3Ô∏è‚É£ Upload project files to EC2
      - name: Upload Files to EC2
        run: |
          echo "üìÅ Cleaning old folder on EC2..."
          ssh -o StrictHostKeyChecking=no -i ec2key.pem ubuntu@${{ secrets.VM_IP }} "rm -rf /home/ubuntu/gdr-nodeapp && mkdir -p /home/ubuntu/gdr-nodeapp"

          echo "üì§ Uploading project files..."
          scp -r -o StrictHostKeyChecking=no -i ec2key.pem $GITHUB_WORKSPACE/* \
          ubuntu@${{ secrets.VM_IP }}:/home/ubuntu/gdr-nodeapp

      # 4Ô∏è‚É£ Build & Deploy on EC2 via Docker
      - name: Build & Deploy on EC2
        run: |
          ssh -o StrictHostKeyChecking=no -i ec2key.pem ubuntu@${{ secrets.VM_IP }} << 'EOF'
          
          echo "üöÄ Starting Docker deployment..."

          cd /home/ubuntu/gdr-nodeapp

          echo "üõ† Building Docker image..."
          sudo docker build -t nodeapp-image .

          echo "üõë Stopping old container (if exists)..."
          sudo docker stop nodeapp-container || true
          sudo docker rm nodeapp-container || true

          echo "üèÉ Running new container..."
          sudo docker run -d --name nodeapp-container -p 80:80 nodeapp-image

          echo "‚úÖ Deployment completed successfully!"
          
EOF
