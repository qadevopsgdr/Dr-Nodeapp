name: Deploy Node App to EC2 - cicd.yaml..

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repository
      - name: Checkout Code
        uses: actions/checkout@v3

      # 2. Save private key
      - name: Load SSH Key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > ec2key.pem
          chmod 400 ec2key.pem

      # 3. Copy project files to EC2
      - name: Upload Files to EC2
        run: |
      

          scp -r -o StrictHostKeyChecking=no -i ec2key.pem ./* ubuntu@${{ secrets.VM_IP }}:/home/ubuntu/gdr-nodeapp

      # 4. SSH into EC2 and deploy with Docker
      - name: Build & Deploy on EC2
        run: |
          ssh -o StrictHostKeyChecking=no -i ec2key.pem ubuntu@${{ secrets.VM_IP }} << 'EOF'

          echo "ðŸš€ Starting Docker deployment..."

          cd /home/ubuntu/gdr-nodeapp

          echo "ðŸ›  Building Docker image..."
          sudo docker build -t nodeapp-image .

          echo "ðŸ›‘ Stopping old container..."
          sudo docker stop nodeapp-container || true
          sudo docker rm nodeapp-container || true

          echo "ðŸƒ Running new container..."
          sudo docker run -d --name nodeapp-container -p 80:80 nodeapp-image

          echo "âœ… Deployment completed successfully!"
          EOF
