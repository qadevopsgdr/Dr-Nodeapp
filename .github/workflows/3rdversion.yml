name: Deploy Node App to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repository
      - name: Checkout Code
        uses: actions/checkout@v3

      # 2. Save SSH key for EC2 login
      - name: Load SSH Key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > ec2key.pem
          chmod 400 ec2key.pem

      # 3. Clean remote folder BEFORE copying files
      - name: Clean Remote Directory
        run: |
          ssh -o StrictHostKeyChecking=no -i ec2key.pem ubuntu@${{ secrets.VM_IP }} "
            sudo rm -rf /home/ubuntu/17nodeapp/*
          "

      # 4. Upload project files to EC2 (excluding ec2key.pem)
      - name: Upload Application Files
        run: |
          scp -r -o StrictHostKeyChecking=no -i ec2key.pem \
            app.js package.json Dockerfile \
            ubuntu@${{ secrets.VM_IP }}:/home/ubuntu/17nodeapp/

      # 5. Build & Deploy Node App using Docker
      - name: Build and Run Docker Container on EC2
        run: |
          ssh -o StrictHostKeyChecking=no -i ec2key.pem ubuntu@${{ secrets.VM_IP }} << 'EOF'
          
            echo "ðŸš€ Starting Deployment..."

            cd /home/ubuntu/17nodeapp

            echo "ðŸ›  Building Docker Image..."
            sudo docker build -t nodeapp-image .

            echo "ðŸ›‘ Removing old container if exists..."
            sudo docker rm -f nodeapp-container || true

            echo "ðŸƒ Starting new container..."
            sudo docker run -d --name nodeapp-container -p 80:80 nodeapp-image

            echo "âœ… Deployment Success!"
          EOF
